<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Nilorea Library: n_common.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>n_common.c</h1>  </div>
</div>
<div class="contents">
<a href="n__common_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**\file n_common.c</span>
<a name="l00002"></a>00002 <span class="comment"> *  common function</span>
<a name="l00003"></a>00003 <span class="comment"> *\author Castagnier Mickael</span>
<a name="l00004"></a>00004 <span class="comment"> *\version 1.0</span>
<a name="l00005"></a>00005 <span class="comment"> *\date 24/03/05</span>
<a name="l00006"></a>00006 <span class="comment"> */</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;nilorea/n_common.h&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;nilorea/n_log.h&quot;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="preprocessor">#if defined(LINUX) || defined(SOLARIS)</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#endif</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment">/*! int file_exist( const char *filename )</span>
<a name="l00017"></a>00017 <span class="comment"> *\brief test if file exist and if it&#39;s readable</span>
<a name="l00018"></a>00018 <span class="comment"> *\param filename Path/name of the file </span>
<a name="l00019"></a>00019 <span class="comment"> *\return TRUE or FALSE </span>
<a name="l00020"></a>00020 <span class="comment"> */</span>
<a name="l00021"></a><a class="code" href="n__common_8c.html#ae51b692bea533096e5839a3dc5500780">00021</a> <span class="keywordtype">int</span> <a class="code" href="n__common_8c.html#ae51b692bea533096e5839a3dc5500780" title="test if file exist and if it&amp;#39;s readable">file_exist</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> *filename )
<a name="l00022"></a>00022 {
<a name="l00023"></a>00023                 FILE *file = NULL ;
<a name="l00024"></a>00024                 <span class="keywordflow">if</span>( ( file = fopen( filename , <span class="stringliteral">&quot;r&quot;</span> ) ) != NULL )
<a name="l00025"></a>00025                 {
<a name="l00026"></a>00026                                 fclose(file);
<a name="l00027"></a>00027                                 <span class="keywordflow">return</span> 1 ;
<a name="l00028"></a>00028                 }
<a name="l00029"></a>00029                 <span class="keywordflow">return</span> 0;
<a name="l00030"></a>00030 } <span class="comment">/* file_exist */</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment"></span>
<a name="l00034"></a>00034 <span class="comment">/*!\fn char *get_prog_dir( void )</span>
<a name="l00035"></a>00035 <span class="comment"> *\brief get current program running directory</span>
<a name="l00036"></a>00036 <span class="comment"> *\return A copy of the current program running directory inside a string</span>
<a name="l00037"></a>00037 <span class="comment"> */</span>
<a name="l00038"></a><a class="code" href="n__common_8c.html#ab277acf7b61b1226c3cbb1811c1359e1">00038</a> <span class="keywordtype">char</span> *<a class="code" href="n__common_8c.html#ab277acf7b61b1226c3cbb1811c1359e1" title="get current program running directory">get_prog_dir</a>( <span class="keywordtype">void</span> )
<a name="l00039"></a>00039 {
<a name="l00040"></a>00040                 <span class="keywordtype">char</span> strbuf[ PATH_MAX ] = <span class="stringliteral">&quot;&quot;</span> ;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042                 <span class="keywordtype">int</span> error = 0 ;
<a name="l00043"></a>00043 <span class="preprocessor">#ifdef WINDOWS</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>                <span class="keywordtype">int</span> bytes = GetModuleFileName( NULL , strbuf , PATH_MAX );
<a name="l00045"></a>00045                 error = errno ;
<a name="l00046"></a>00046                 <span class="keywordflow">if</span>(bytes != 0)
<a name="l00047"></a>00047                 {
<a name="l00048"></a>00048                                 <span class="keywordflow">return</span> strdup( dirname(strbuf ) );
<a name="l00049"></a>00049                 }
<a name="l00050"></a>00050 <span class="preprocessor">#else</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>                <span class="keywordtype">char</span> procbuf[ PATH_MAX ] = <span class="stringliteral">&quot;&quot;</span> ;
<a name="l00052"></a>00052 <span class="preprocessor">#ifdef LINUX</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>                sprintf( procbuf , <span class="stringliteral">&quot;/proc/%d/exe&quot;</span>, (<span class="keywordtype">int</span>)getpid() );
<a name="l00054"></a>00054 <span class="preprocessor">#elif defined SOLARIS</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>                sprintf( procbuf , <span class="stringliteral">&quot;/proc/%d/path/a.out&quot;</span>, (<span class="keywordtype">int</span>)getpid() );
<a name="l00056"></a>00056 <span class="preprocessor">#endif</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>                <span class="keywordtype">int</span> bytes = MIN( readlink( procbuf , strbuf , PATH_MAX ) , PATH_MAX - 1 );
<a name="l00058"></a>00058                 error = errno ;
<a name="l00059"></a>00059                 <span class="keywordflow">if</span>( bytes &gt;= 0 )
<a name="l00060"></a>00060                 {
<a name="l00061"></a>00061                                 strbuf[ bytes ] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00062"></a>00062                                 <span class="keywordflow">return</span> strdup( dirname( strbuf ) );
<a name="l00063"></a>00063                 }
<a name="l00064"></a>00064 <span class="preprocessor">#endif</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>                fprintf( stderr , <span class="stringliteral">&quot;%s&quot;</span> , strerror( error ) );
<a name="l00066"></a>00066                 <span class="keywordflow">return</span> NULL ;
<a name="l00067"></a>00067 } <span class="comment">/* get_prog_dir */</span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="comment"></span>
<a name="l00070"></a>00070 <span class="comment">/*!\fn char *get_prog_name( void )</span>
<a name="l00071"></a>00071 <span class="comment"> *\brief get current program name</span>
<a name="l00072"></a>00072 <span class="comment"> *\return A copy of the current program name inside a string</span>
<a name="l00073"></a>00073 <span class="comment"> */</span>
<a name="l00074"></a><a class="code" href="n__common_8c.html#a121f484b21cd361e6fa84b1720762922">00074</a> <span class="keywordtype">char</span> *<a class="code" href="n__common_8c.html#a121f484b21cd361e6fa84b1720762922" title="get current program name">get_prog_name</a>( <span class="keywordtype">void</span> )
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076                 <span class="keywordtype">char</span> strbuf[ PATH_MAX ] = <span class="stringliteral">&quot;&quot;</span> ;
<a name="l00077"></a>00077                 <span class="keywordtype">int</span> error = 0 ;
<a name="l00078"></a>00078 <span class="preprocessor">#ifdef WINDOWS</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>                <span class="keywordtype">int</span> bytes = GetModuleFileName( NULL , strbuf , PATH_MAX );
<a name="l00080"></a>00080                 error = errno ;
<a name="l00081"></a>00081                 <span class="keywordflow">if</span>(bytes != 0)
<a name="l00082"></a>00082                 {
<a name="l00083"></a>00083                                 <span class="keywordflow">return</span> strdup( basename(strbuf ) );
<a name="l00084"></a>00084                 }
<a name="l00085"></a>00085 <span class="preprocessor">#else</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>                <span class="keywordtype">char</span> procbuf[ PATH_MAX ] = <span class="stringliteral">&quot;&quot;</span> ;
<a name="l00087"></a>00087 <span class="preprocessor">#ifdef LINUX</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>                sprintf( procbuf , <span class="stringliteral">&quot;/proc/%d/exe&quot;</span>, (<span class="keywordtype">int</span>)getpid() );
<a name="l00089"></a>00089 <span class="preprocessor">#elif defined SOLARIS</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span>                sprintf( procbuf , <span class="stringliteral">&quot;/proc/%d/path/a.out&quot;</span>, (<span class="keywordtype">int</span>)getpid() );
<a name="l00091"></a>00091 <span class="preprocessor">#endif</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>                <span class="keywordtype">int</span> bytes = MIN( readlink( procbuf , strbuf , PATH_MAX ) , PATH_MAX - 1 );
<a name="l00093"></a>00093                 error = errno ;
<a name="l00094"></a>00094                 <span class="keywordflow">if</span>( bytes &gt;= 0 )
<a name="l00095"></a>00095                 {
<a name="l00096"></a>00096                                 strbuf[ bytes ] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00097"></a>00097                                 <span class="keywordflow">return</span> strdup( basename( strbuf ) );
<a name="l00098"></a>00098                 }
<a name="l00099"></a>00099 <span class="preprocessor">#endif</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>                fprintf( stderr , <span class="stringliteral">&quot;%s&quot;</span> , strerror( error ) );
<a name="l00101"></a>00101                 <span class="keywordflow">return</span> NULL ;
<a name="l00102"></a>00102 } <span class="comment">/* get_prog_dir */</span>
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="preprocessor">#ifndef NOALLEGRO</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span><span class="comment">/*!\fn void get_keyboard( char *keybuf , int *cur , int min , int max )</span>
<a name="l00108"></a>00108 <span class="comment"> *\brief Function for getting a keyboard input, unicode</span>
<a name="l00109"></a>00109 <span class="comment"> *\param keybuf a valid char buffer</span>
<a name="l00110"></a>00110 <span class="comment"> *\param cur a pointer to the current_cursor_position</span>
<a name="l00111"></a>00111 <span class="comment"> *\param min the minimum carret position in byte</span>
<a name="l00112"></a>00112 <span class="comment"> *\param max the maximim carret position in byte</span>
<a name="l00113"></a>00113 <span class="comment"> */</span>
<a name="l00114"></a><a class="code" href="n__common_8c.html#a10f6f1ccb98559703c0a564d8c837162">00114</a> <span class="keywordtype">void</span> <a class="code" href="n__common_8c.html#a10f6f1ccb98559703c0a564d8c837162" title="Function for getting a keyboard input, unicode.">get_keyboard</a>( <span class="keywordtype">char</span> *keybuf , <span class="keywordtype">int</span> *cur , <span class="keywordtype">int</span> min , <span class="keywordtype">int</span> max )
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116                 <span class="keywordtype">int</span> k = 0;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118                 <span class="keywordflow">if</span> ( keypressed() ) 
<a name="l00119"></a>00119                 {
<a name="l00120"></a>00120                                 k = ureadkey( NULL );
<a name="l00121"></a>00121 
<a name="l00122"></a>00122                                 <span class="keywordflow">if</span> ( k != 0x1b &amp;&amp; k != 0x09 &amp;&amp; k != 0x00 &amp;&amp; k != 0x0d &amp;&amp; k != 0x08 &amp;&amp; ( *cur ) &lt; max ) 
<a name="l00123"></a>00123                                 {
<a name="l00124"></a>00124                                                 usprintf( keybuf + ustrsize( keybuf ) , <span class="stringliteral">&quot;%c&quot;</span> , k );
<a name="l00125"></a>00125                                                 ( *cur ) ++;
<a name="l00126"></a>00126                                 } 
<a name="l00127"></a>00127 
<a name="l00128"></a>00128                                 <span class="keywordflow">if</span> ( k == 0x08 &amp;&amp; (*cur) &gt; min )  <span class="comment">/* backspace */</span>
<a name="l00129"></a>00129                                 {
<a name="l00130"></a>00130                                                 ( *cur ) --;
<a name="l00131"></a>00131                                                 uremove( keybuf , ( *cur ) );
<a name="l00132"></a>00132                                 }
<a name="l00133"></a>00133                 } <span class="comment">/* if( keypressed( ... ) ) */</span>
<a name="l00134"></a>00134 } <span class="comment">/* get_keyboard(...) */</span>
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 <span class="comment">/* #ifndef NOALLEGRO */</span>
<a name="l00137"></a>00137 <span class="preprocessor">#endif </span>
<a name="l00138"></a>00138 <span class="preprocessor"></span>
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 <span class="preprocessor">#ifndef WINDOWS</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span><span class="comment">/*!\fn n_daemonize( void )</span>
<a name="l00143"></a>00143 <span class="comment"> *\brief Daemonize program</span>
<a name="l00144"></a>00144 <span class="comment"> *\return TRUE or FALSE</span>
<a name="l00145"></a>00145 <span class="comment"> */</span>
<a name="l00146"></a><a class="code" href="n__common_8c.html#a3f1bbac4c90d48e9a25496b69719707b">00146</a> <span class="keywordtype">int</span> <a class="code" href="n__common_8c.html#a3f1bbac4c90d48e9a25496b69719707b" title="Daemonize program.">n_daemonize</a>( <span class="keywordtype">void</span> )
<a name="l00147"></a>00147 {
<a name="l00148"></a>00148                 <span class="comment">/* Fork off the parent process */</span>
<a name="l00149"></a>00149                 pid_t pid = fork();
<a name="l00150"></a>00150                 <span class="keywordflow">if</span>( pid &lt; 0 )
<a name="l00151"></a>00151                 {
<a name="l00152"></a>00152                                 n_log( LOG_ERR , <span class="stringliteral">&quot;Error: unable to fork child: %s&quot;</span> , strerror( errno ) );
<a name="l00153"></a>00153                                 exit( 1 );
<a name="l00154"></a>00154                 }
<a name="l00155"></a>00155                 <span class="keywordflow">if</span>( pid &gt; 0 )
<a name="l00156"></a>00156                 {
<a name="l00157"></a>00157                                 n_log( LOG_NOTICE , <span class="stringliteral">&quot;Child started successfuly !&quot;</span> );
<a name="l00158"></a>00158                                 exit( 0 );
<a name="l00159"></a>00159                 }
<a name="l00160"></a>00160                 <span class="comment">/* Close all open file descriptors */</span>
<a name="l00161"></a>00161                 <span class="keywordtype">int</span> x = 0 ;
<a name="l00162"></a>00162                 <span class="keywordflow">for</span>(x = sysconf( _SC_OPEN_MAX ) ; x &gt;= 0 ; x-- )
<a name="l00163"></a>00163                 {
<a name="l00164"></a>00164                                 close(x);
<a name="l00165"></a>00165                 }
<a name="l00166"></a>00166                 <span class="keywordtype">int</span> fd = open(<span class="stringliteral">&quot;/dev/null&quot;</span>,O_RDWR, 0);
<a name="l00167"></a>00167     <span class="keywordflow">if</span> (fd != -1)
<a name="l00168"></a>00168     {
<a name="l00169"></a>00169         dup2 (fd, STDIN_FILENO);
<a name="l00170"></a>00170         dup2 (fd, STDOUT_FILENO);
<a name="l00171"></a>00171         dup2 (fd, STDERR_FILENO);
<a name="l00172"></a>00172         <span class="keywordflow">if</span> (fd &gt; 2)
<a name="l00173"></a>00173         {
<a name="l00174"></a>00174             close (fd);
<a name="l00175"></a>00175         }
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177                 <span class="keywordflow">else</span>
<a name="l00178"></a>00178                 {
<a name="l00179"></a>00179                                 n_log( LOG_ERR , <span class="stringliteral">&quot;Failed to open /dev/null&quot;</span> );
<a name="l00180"></a>00180                 }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182                 <span class="comment">/* On success: The child process becomes session leader */</span>
<a name="l00183"></a>00183                 <span class="keywordflow">if</span>( setsid() &lt; 0 )
<a name="l00184"></a>00184                 {
<a name="l00185"></a>00185                                 n_log( LOG_ERR , <span class="stringliteral">&quot;Error: unable to set session leader with setsid(): %s&quot;</span> , strerror( errno ) );
<a name="l00186"></a>00186                                 exit( 1 );
<a name="l00187"></a>00187                 }
<a name="l00188"></a>00188                 <span class="keywordflow">else</span>
<a name="l00189"></a>00189                 {
<a name="l00190"></a>00190                                 n_log( LOG_NOTICE , <span class="stringliteral">&quot;Session leader set !&quot;</span> );
<a name="l00191"></a>00191                 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193                 <span class="keywordflow">return</span> TRUE ;
<a name="l00194"></a>00194 } <span class="comment">/* n_daemonize(...) */</span>
<a name="l00195"></a>00195 <span class="preprocessor">#endif</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Oct 26 2018 12:00:38 for Nilorea Library by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
