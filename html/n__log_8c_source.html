<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Nilorea Library: n_log.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>n_log.c</h1>  </div>
</div>
<div class="contents">
<a href="n__log_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*\file n_log.c</span>
<a name="l00002"></a>00002 <span class="comment"> * generic logging system</span>
<a name="l00003"></a>00003 <span class="comment"> *\author Castagnier Mickael</span>
<a name="l00004"></a>00004 <span class="comment"> *\date 2013-03-12</span>
<a name="l00005"></a>00005 <span class="comment"> */</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="comment">/* for vasprintf */</span>
<a name="l00008"></a>00008 <span class="preprocessor">#ifdef LINUX</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor">#ifndef _GNU_SOURCE</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor">#define _GNU_SOURCE</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;nilorea/n_common.h&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;nilorea/n_log.h&quot;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="comment"></span>
<a name="l00020"></a>00020 <span class="comment">/*! internal struct to handle log types */</span>
<a name="l00021"></a><a class="code" href="struct__code.html">00021</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct__code.html">_code</a> {<span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment">                /*! string of log type */</span>
<a name="l00023"></a><a class="code" href="struct__code.html#af7c81a6f1d004f4d724369fdbfaa2f6f">00023</a>                 <span class="keywordtype">char</span> *<a class="code" href="struct__code.html#af7c81a6f1d004f4d724369fdbfaa2f6f">c_name</a>;<span class="comment"></span>
<a name="l00024"></a>00024 <span class="comment">                /*! numeric value of log type */</span>
<a name="l00025"></a><a class="code" href="struct__code.html#ab62b1549bf7bcd146db576a421ad2228">00025</a>                 <span class="keywordtype">int</span>             <a class="code" href="struct__code.html#ab62b1549bf7bcd146db576a421ad2228">c_val</a>;<span class="comment"></span>
<a name="l00026"></a>00026 <span class="comment">                /*! event log value */</span>
<a name="l00027"></a><a class="code" href="struct__code.html#abdc21d00e480bac701a1e1a950198d41">00027</a>                 <span class="keywordtype">char</span> *<a class="code" href="struct__code.html#abdc21d00e480bac701a1e1a950198d41">w_name</a>;
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 } <a class="code" href="n__log_8c.html#a733b24e5119ca1c7cebf063ab65514d2">CODE</a>;
<a name="l00030"></a>00030 <span class="comment"></span>
<a name="l00031"></a>00031 <span class="comment">/*! array of log levels */</span>
<a name="l00032"></a><a class="code" href="n__log_8c.html#ae50cc67fec897f9186f2f754cd049f05">00032</a> <span class="keyword">static</span> <a class="code" href="struct__code.html">CODE</a> <a class="code" href="n__log_8c.html#ae50cc67fec897f9186f2f754cd049f05">prioritynames</a>[] = {
<a name="l00033"></a>00033                 {               <span class="stringliteral">&quot;EMERG&quot;</span>,        LOG_EMERG,                      <span class="stringliteral">&quot;ERROR&quot;</span> },
<a name="l00034"></a>00034                 {               <span class="stringliteral">&quot;ALERT&quot;</span>,        LOG_ALERT,                      <span class="stringliteral">&quot;ERROR&quot;</span> },
<a name="l00035"></a>00035                 {               <span class="stringliteral">&quot;CRITICAL&quot;</span>,     LOG_CRIT,                       <span class="stringliteral">&quot;ERROR&quot;</span> },
<a name="l00036"></a>00036                 {               <span class="stringliteral">&quot;ERROR&quot;</span>,        LOG_ERR,                        <span class="stringliteral">&quot;ERROR&quot;</span> },
<a name="l00037"></a>00037                 {               <span class="stringliteral">&quot;WARNING&quot;</span>,      LOG_WARNING,    <span class="stringliteral">&quot;WARNING&quot;</span> },
<a name="l00038"></a>00038                 {               <span class="stringliteral">&quot;NOTICE&quot;</span>,       LOG_NOTICE,                     <span class="stringliteral">&quot;SUCCESS&quot;</span> },
<a name="l00039"></a>00039                 {               <span class="stringliteral">&quot;INFO&quot;</span>,                         LOG_INFO,                       <span class="stringliteral">&quot;INFORMATION&quot;</span> },
<a name="l00040"></a>00040                 {               <span class="stringliteral">&quot;DEBUG&quot;</span>,        LOG_DEBUG,                      <span class="stringliteral">&quot;INFORMATION&quot;</span> },
<a name="l00041"></a>00041                 {               NULL,                           -1,                                              NULL }
<a name="l00042"></a>00042 };
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="comment"></span>
<a name="l00045"></a>00045 <span class="comment">/*! static global maximum wanted log level value */</span>
<a name="l00046"></a><a class="code" href="n__log_8c.html#a3ecebc9d2fcb9f207a3373191a0ca251">00046</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="n__log_8c.html#a3ecebc9d2fcb9f207a3373191a0ca251">LOG_LEVEL</a> = LOG_NULL ;
<a name="l00047"></a>00047 <span class="comment"></span>
<a name="l00048"></a>00048 <span class="comment">/*! static global logging type ( STDERR, FILE, SYSJRNL ) */</span>
<a name="l00049"></a><a class="code" href="n__log_8c.html#a538d7688bbf77876683ab43e3632b204">00049</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="n__log_8c.html#a538d7688bbf77876683ab43e3632b204">LOG_TYPE</a> = LOG_STDERR ;
<a name="l00050"></a>00050 <span class="comment"></span>
<a name="l00051"></a>00051 <span class="comment">/*! static FILE handling if logging to file is enabled */</span>
<a name="l00052"></a><a class="code" href="n__log_8c.html#ab936051f5aaca44c6c3c41dee0d19c36">00052</a> <span class="keyword">static</span> FILE *<a class="code" href="n__log_8c.html#ab936051f5aaca44c6c3c41dee0d19c36">log_file</a> = NULL ;
<a name="l00053"></a>00053 <span class="comment"></span>
<a name="l00054"></a>00054 <span class="comment">/*! static proc name, for windows event log */</span>
<a name="l00055"></a><a class="code" href="n__log_8c.html#a2935a9f42014b138d8e8cf7de161450c">00055</a> <span class="keywordtype">char</span> *<a class="code" href="n__log_8c.html#a2935a9f42014b138d8e8cf7de161450c">proc_name</a> = NULL ;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="comment"></span>
<a name="l00058"></a>00058 <span class="comment">/*!\fn open_sysjrnl( char *identity )</span>
<a name="l00059"></a>00059 <span class="comment"> *\brief Open connection to syslog or create internals for event log</span>
<a name="l00060"></a>00060 <span class="comment"> *\param identity Tag for syslog or NULL to use argv[0]</span>
<a name="l00061"></a>00061 <span class="comment"> *\return NULL or identity if success</span>
<a name="l00062"></a>00062 <span class="comment"> */</span>
<a name="l00063"></a><a class="code" href="n__log_8c.html#a950aea9fff566e5fb10d0878afa49e07">00063</a> <span class="keywordtype">char</span> *<a class="code" href="n__log_8c.html#a950aea9fff566e5fb10d0878afa49e07" title="Open connection to syslog or create internals for event log.">open_sysjrnl</a>( <span class="keywordtype">char</span> *identity )
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065                 __n_assert( identity , <span class="keywordflow">return</span> NULL );
<a name="l00066"></a>00066 <span class="preprocessor">#ifndef NOSYSJRNL</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span>                <span class="comment">/* LOG_CONS: log to console if no syslog available </span>
<a name="l00068"></a>00068 <span class="comment">                 * LOG_PID: add pid of calling process to log</span>
<a name="l00069"></a>00069 <span class="comment">                 * Local use 7 : compat with older logging systems</span>
<a name="l00070"></a>00070 <span class="comment">                 */</span>
<a name="l00071"></a>00071                 openlog ( identity , LOG_CONS|LOG_PID|LOG_NDELAY , LOG_LOCAL7 );
<a name="l00072"></a>00072 <span class="preprocessor">#endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>                <a class="code" href="n__log_8c.html#a2935a9f42014b138d8e8cf7de161450c">proc_name</a> = strdup( identity );
<a name="l00074"></a>00074                 <span class="keywordflow">return</span> <a class="code" href="n__log_8c.html#a2935a9f42014b138d8e8cf7de161450c">proc_name</a> ;
<a name="l00075"></a>00075 } <span class="comment">/* open_sysjrnl */</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="comment"></span>
<a name="l00079"></a>00079 <span class="comment">/*!\fn void close_sysjrnl( void )</span>
<a name="l00080"></a>00080 <span class="comment"> * \brief Close syslog connection or clean internals for event log</span>
<a name="l00081"></a>00081 <span class="comment"> */</span>
<a name="l00082"></a><a class="code" href="n__log_8c.html#a6b48448b4bb689cc55c6a7267daf77ca">00082</a> <span class="keywordtype">void</span> <a class="code" href="n__log_8c.html#a6b48448b4bb689cc55c6a7267daf77ca" title="Close syslog connection or clean internals for event log.">close_sysjrnl</a>( <span class="keywordtype">void</span> )
<a name="l00083"></a>00083 {
<a name="l00084"></a>00084 <span class="preprocessor">#ifndef NOSYSJRNL</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span>                closelog();
<a name="l00086"></a>00086 <span class="preprocessor">#endif</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>                FreeNoLog( <a class="code" href="n__log_8c.html#a2935a9f42014b138d8e8cf7de161450c">proc_name</a> );
<a name="l00088"></a>00088 } <span class="comment">/* close_sysjrnl */</span>
<a name="l00089"></a>00089  
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="comment"></span>
<a name="l00092"></a>00092 <span class="comment">/*!\fn void set_log_level( int log_level )</span>
<a name="l00093"></a>00093 <span class="comment"> *\brief Set the global log level value ( static int LOG_LEVEL )</span>
<a name="l00094"></a>00094 <span class="comment"> *\param log_level Log level value. Supported: JRNLONLY,NOLOG,LOG_NOTICE/INFO/ERR/DEBUG,LOG_FILE/STDERR/SYSJRNL</span>
<a name="l00095"></a>00095 <span class="comment"> */</span>
<a name="l00096"></a><a class="code" href="n__log_8c.html#acad9b2d55788f46ddde811c986ead9ae">00096</a> <span class="keywordtype">void</span> <a class="code" href="n__log_8c.html#acad9b2d55788f46ddde811c986ead9ae" title="Set the global log level value ( static int LOG_LEVEL )">set_log_level</a>( <span class="keyword">const</span> <span class="keywordtype">int</span> log_level )
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098                 <span class="keywordflow">if</span>( log_level == LOG_FILE )
<a name="l00099"></a>00099                 {
<a name="l00100"></a>00100                                 <a class="code" href="n__log_8c.html#a538d7688bbf77876683ab43e3632b204">LOG_TYPE</a> = LOG_FILE ;
<a name="l00101"></a>00101                                 return ;
<a name="l00102"></a>00102                 }
<a name="l00103"></a>00103                 <span class="keywordflow">if</span>( log_level == LOG_STDERR )
<a name="l00104"></a>00104                 {
<a name="l00105"></a>00105                                 <a class="code" href="n__log_8c.html#a538d7688bbf77876683ab43e3632b204">LOG_TYPE</a> = LOG_STDERR ;
<a name="l00106"></a>00106                                 return ;
<a name="l00107"></a>00107                 }
<a name="l00108"></a>00108                 <span class="keywordflow">if</span>( log_level == LOG_SYSJRNL )
<a name="l00109"></a>00109                 {
<a name="l00110"></a>00110                                 <a class="code" href="n__log_8c.html#a538d7688bbf77876683ab43e3632b204">LOG_TYPE</a> = LOG_SYSJRNL ;
<a name="l00111"></a>00111                                 return ;
<a name="l00112"></a>00112                 }
<a name="l00113"></a>00113                 <a class="code" href="n__log_8c.html#a3ecebc9d2fcb9f207a3373191a0ca251">LOG_LEVEL</a> = log_level ;
<a name="l00114"></a>00114 } <span class="comment">/* set_log_level() */</span> 
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="comment"></span>
<a name="l00118"></a>00118 <span class="comment">/*!\fn int get_log_level( )</span>
<a name="l00119"></a>00119 <span class="comment"> *\brief Get the global log level value</span>
<a name="l00120"></a>00120 <span class="comment"> *\return static int LOG_LEVEL</span>
<a name="l00121"></a>00121 <span class="comment"> */</span>
<a name="l00122"></a><a class="code" href="n__log_8c.html#afeea44ab08778cbff68e91e831d44112">00122</a> <span class="keywordtype">int</span> <a class="code" href="n__log_8c.html#afeea44ab08778cbff68e91e831d44112" title="Get the global log level value.">get_log_level</a>( <span class="keywordtype">void</span> )
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124                 <span class="keywordflow">return</span> <a class="code" href="n__log_8c.html#a3ecebc9d2fcb9f207a3373191a0ca251">LOG_LEVEL</a> ;
<a name="l00125"></a>00125 } <span class="comment">/* get_log_level() */</span>
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 <span class="comment"></span>
<a name="l00129"></a>00129 <span class="comment">/*!\fn int set_log_file( char *file )</span>
<a name="l00130"></a>00130 <span class="comment"> *\brief Set the logging to a file instead of stderr</span>
<a name="l00131"></a>00131 <span class="comment"> *\param file The filename where to log</span>
<a name="l00132"></a>00132 <span class="comment"> *\return TRUE or FALSE</span>
<a name="l00133"></a>00133 <span class="comment"> */</span>
<a name="l00134"></a><a class="code" href="n__log_8c.html#ac83aa9829ddf0d169e2890ef63052b52">00134</a> <span class="keywordtype">int</span> <a class="code" href="n__log_8c.html#ac83aa9829ddf0d169e2890ef63052b52" title="Set the logging to a file instead of stderr.">set_log_file</a>( <span class="keywordtype">char</span> *file )
<a name="l00135"></a>00135 {               
<a name="l00136"></a>00136                 __n_assert( file , <span class="keywordflow">return</span> FALSE );
<a name="l00137"></a>00137 
<a name="l00138"></a>00138                 <span class="keywordflow">if</span>( !<a class="code" href="n__log_8c.html#ab936051f5aaca44c6c3c41dee0d19c36">log_file</a> )
<a name="l00139"></a>00139                                 <a class="code" href="n__log_8c.html#ab936051f5aaca44c6c3c41dee0d19c36">log_file</a> = fopen( file , <span class="stringliteral">&quot;w&quot;</span> );
<a name="l00140"></a>00140                 <span class="keywordflow">else</span>
<a name="l00141"></a>00141                 {
<a name="l00142"></a>00142                                 fclose( <a class="code" href="n__log_8c.html#ab936051f5aaca44c6c3c41dee0d19c36">log_file</a> );
<a name="l00143"></a>00143                                 <a class="code" href="n__log_8c.html#ab936051f5aaca44c6c3c41dee0d19c36">log_file</a> = fopen( file , <span class="stringliteral">&quot;w&quot;</span> );
<a name="l00144"></a>00144                 }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146                 <a class="code" href="n__log_8c.html#acad9b2d55788f46ddde811c986ead9ae" title="Set the global log level value ( static int LOG_LEVEL )">set_log_level</a>( LOG_FILE );
<a name="l00147"></a>00147 
<a name="l00148"></a>00148                 __n_assert( <a class="code" href="n__log_8c.html#ab936051f5aaca44c6c3c41dee0d19c36">log_file</a> , <span class="keywordflow">return</span> FALSE );
<a name="l00149"></a>00149 
<a name="l00150"></a>00150                 <span class="keywordflow">return</span> TRUE ;
<a name="l00151"></a>00151 } <span class="comment">/* set_log_file */</span>
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 <span class="comment"></span>
<a name="l00155"></a>00155 <span class="comment">/*!\fn FILE *get_log_file()</span>
<a name="l00156"></a>00156 <span class="comment"> *\brief return the current log_file</span>
<a name="l00157"></a>00157 <span class="comment"> *\return a valid FILE handle or NULL </span>
<a name="l00158"></a>00158 <span class="comment"> */</span>
<a name="l00159"></a><a class="code" href="n__log_8c.html#a2ff7ac3ed2362bf2820e1639b4ddaf8f">00159</a> FILE *<a class="code" href="n__log_8c.html#a2ff7ac3ed2362bf2820e1639b4ddaf8f" title="return the current log_file">get_log_file</a>( <span class="keywordtype">void</span> )
<a name="l00160"></a>00160 {
<a name="l00161"></a>00161                 <span class="keywordflow">return</span> <a class="code" href="n__log_8c.html#ab936051f5aaca44c6c3c41dee0d19c36">log_file</a> ;
<a name="l00162"></a>00162 } <span class="comment">/*get_log_level() */</span>
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 <span class="preprocessor">#ifndef _vscprintf</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span><span class="comment">/* For some reason, MSVC fails to honour this #ifndef. */</span>
<a name="l00166"></a>00166 <span class="comment">/* Hence function renamed to _vscprintf_so(). */</span>
<a name="l00167"></a><a class="code" href="n__log_8c.html#afe6a9c3590b857b2efb7a03938a44d5d">00167</a> <span class="keywordtype">int</span> <a class="code" href="n__log_8c.html#afe6a9c3590b857b2efb7a03938a44d5d">_vscprintf_so</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * format, va_list pargs) {
<a name="l00168"></a>00168                 <span class="keywordtype">int</span> retval;
<a name="l00169"></a>00169                 va_list argcopy;
<a name="l00170"></a>00170                 va_copy(argcopy, pargs);
<a name="l00171"></a>00171                 retval = vsnprintf(NULL, 0, format, argcopy);
<a name="l00172"></a>00172                 va_end(argcopy);
<a name="l00173"></a>00173                 <span class="keywordflow">return</span> retval;}
<a name="l00174"></a>00174 <span class="preprocessor">#endif </span>
<a name="l00175"></a>00175 <span class="preprocessor"></span>
<a name="l00176"></a>00176 <span class="preprocessor">#ifndef vasprintf</span>
<a name="l00177"></a><a class="code" href="n__log_8c.html#a5ec7fd90ebe6015636bce974c192c86a">00177</a> <span class="preprocessor"></span>                <span class="keywordtype">int</span> <a class="code" href="n__log_8c.html#a5ec7fd90ebe6015636bce974c192c86a">vasprintf</a>(<span class="keywordtype">char</span> **strp, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, va_list ap) {
<a name="l00178"></a>00178                                 <span class="keywordtype">int</span> len = <a class="code" href="n__log_8c.html#afe6a9c3590b857b2efb7a03938a44d5d">_vscprintf_so</a>(fmt, ap);
<a name="l00179"></a>00179                                 <span class="keywordflow">if</span> (len == -1) <span class="keywordflow">return</span> -1;
<a name="l00180"></a>00180                                 <span class="keywordtype">char</span> *str = malloc((<span class="keywordtype">size_t</span>) len + 1);
<a name="l00181"></a>00181                                 <span class="keywordflow">if</span> (!str) <span class="keywordflow">return</span> -1;
<a name="l00182"></a>00182                                 <span class="keywordtype">int</span> r = vsnprintf(str, len + 1, fmt, ap); <span class="comment">/* &quot;secure&quot; version of vsprintf */</span>
<a name="l00183"></a>00183                                 <span class="keywordflow">if</span> (r == -1) <span class="keywordflow">return</span> free(str), -1;
<a name="l00184"></a>00184                                 *strp = str;
<a name="l00185"></a>00185                                 <span class="keywordflow">return</span> r;}
<a name="l00186"></a>00186 <span class="preprocessor">#endif </span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>
<a name="l00188"></a>00188 <span class="preprocessor">#ifndef asprintf</span>
<a name="l00189"></a><a class="code" href="n__log_8c.html#a6bf15f4f2f46c7238e58afb2ff61f1c4">00189</a> <span class="preprocessor"></span>                                <span class="keywordtype">int</span> <a class="code" href="n__log_8c.html#a6bf15f4f2f46c7238e58afb2ff61f1c4">asprintf</a>(<span class="keywordtype">char</span> *strp[], <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...) {
<a name="l00190"></a>00190                                                 va_list ap;
<a name="l00191"></a>00191                                                 va_start(ap, fmt);
<a name="l00192"></a>00192                                                 <span class="keywordtype">int</span> r = <a class="code" href="n__log_8c.html#a5ec7fd90ebe6015636bce974c192c86a">vasprintf</a>(strp, fmt, ap);
<a name="l00193"></a>00193                                                 va_end(ap);
<a name="l00194"></a>00194                                                 <span class="keywordflow">return</span> r;}
<a name="l00195"></a>00195 <span class="preprocessor">#endif</span>
<a name="l00196"></a>00196 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00197"></a>00197 <span class="comment">                                                /*!\fn void _n_log( int level , const char *file , const char *func , int line , const char *format , ... ) </span>
<a name="l00198"></a>00198 <span class="comment">                                                 *\brief Logging function. log( level , const char *format , ... ) is a macro around _log</span>
<a name="l00199"></a>00199 <span class="comment">                                                 *\param level Logging level </span>
<a name="l00200"></a>00200 <span class="comment">                                                 *\param file File containing the emmited log</span>
<a name="l00201"></a>00201 <span class="comment">                                                 *\param func Function emmiting the log</span>
<a name="l00202"></a>00202 <span class="comment">                                                 *\param line Line of the log</span>
<a name="l00203"></a>00203 <span class="comment">                                                 *\param format Format and string of the log, printf style</span>
<a name="l00204"></a>00204 <span class="comment">                                                 */</span>
<a name="l00205"></a><a class="code" href="n__log_8c.html#afbbbfcb9063b9f1454a499dbf98f7a56">00205</a> <span class="keywordtype">void</span> <a class="code" href="n__log_8c.html#afbbbfcb9063b9f1454a499dbf98f7a56" title="Logging function. log( level , const char *format , ... ) is a macro around _log.">_n_log</a>( <span class="keywordtype">int</span> level , <span class="keyword">const</span> <span class="keywordtype">char</span> *file , <span class="keyword">const</span> <span class="keywordtype">char</span> *func , <span class="keywordtype">int</span> line , <span class="keyword">const</span> <span class="keywordtype">char</span> *format , ... ) 
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207                 va_list args ;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209                 FILE *out = NULL ;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211                 <span class="keywordflow">if</span>( level == LOG_NULL )
<a name="l00212"></a>00212                                 return ;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214                 <span class="keywordflow">if</span>( !<a class="code" href="n__log_8c.html#ab936051f5aaca44c6c3c41dee0d19c36">log_file</a> )
<a name="l00215"></a>00215                                 out = stderr ;
<a name="l00216"></a>00216                 <span class="keywordflow">else</span>
<a name="l00217"></a>00217                                 out = <a class="code" href="n__log_8c.html#ab936051f5aaca44c6c3c41dee0d19c36">log_file</a> ;
<a name="l00218"></a>00218 
<a name="l00219"></a>00219                 <span class="keywordtype">int</span> log_level = <a class="code" href="n__log_8c.html#afeea44ab08778cbff68e91e831d44112" title="Get the global log level value.">get_log_level</a>();
<a name="l00220"></a>00220 
<a name="l00221"></a>00221                 <span class="keywordflow">if</span>( level &lt;= log_level )
<a name="l00222"></a>00222                 {
<a name="l00223"></a>00223                                 <span class="keywordtype">char</span> *syslogbuffer = NULL ;
<a name="l00224"></a>00224                                 <span class="keywordtype">char</span> *eventbuffer = NULL ;
<a name="l00225"></a>00225                                 <span class="keywordtype">char</span> *name = <span class="stringliteral">&quot;NULL&quot;</span> ;
<a name="l00226"></a>00226                                 <span class="keywordflow">if</span>( <a class="code" href="n__log_8c.html#a2935a9f42014b138d8e8cf7de161450c">proc_name</a> )
<a name="l00227"></a>00227                                                 name = <a class="code" href="n__log_8c.html#a2935a9f42014b138d8e8cf7de161450c">proc_name</a> ;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 <span class="preprocessor">#ifndef NOEVENTLOG</span>
<a name="l00230"></a>00230 <span class="preprocessor"></span>                                <span class="keywordtype">size_t</span> needed = 0 ;
<a name="l00231"></a>00231 <span class="preprocessor">#endif</span>
<a name="l00232"></a>00232 <span class="preprocessor"></span>
<a name="l00233"></a>00233                                 <span class="keywordflow">switch</span>( <a class="code" href="n__log_8c.html#a538d7688bbf77876683ab43e3632b204">LOG_TYPE</a> )
<a name="l00234"></a>00234                                 {
<a name="l00235"></a>00235                                                 <span class="keywordflow">case</span> LOG_SYSJRNL :
<a name="l00236"></a>00236                                                                 va_start (args, format);
<a name="l00237"></a>00237                                                                 <a class="code" href="n__log_8c.html#a5ec7fd90ebe6015636bce974c192c86a">vasprintf</a>( &amp;syslogbuffer , format , args ); 
<a name="l00238"></a>00238                                                                 va_end( args );
<a name="l00239"></a>00239 <span class="preprocessor">#ifndef NOSYSJRNL                                                               </span>
<a name="l00240"></a>00240 <span class="preprocessor"></span>                                                                syslog( level , <span class="stringliteral">&quot;%s-&gt;%s:%d %s&quot;</span> , file , func , line , syslogbuffer ); 
<a name="l00241"></a>00241 <span class="preprocessor">#endif</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span><span class="preprocessor">#ifndef NOEVENTLOG</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span>                                                                needed = snprintf( NULL , 0, <span class="stringliteral">&quot;start /B EventCreate /t %s /id 666 /l APPLICATION /so %s /d \&quot;%s\&quot; &gt; NUL 2&gt;&amp;1&quot;</span>, prioritynames[ level ] . w_name , name , syslogbuffer );
<a name="l00244"></a>00244                                                                 Malloc( eventbuffer , <span class="keywordtype">char</span> , needed + 4 );
<a name="l00245"></a>00245                                                                 sprintf( eventbuffer , <span class="stringliteral">&quot;start /B EventCreate /t %s /id 666 /l APPLICATION /so %s /d \&quot;%s\&quot; &gt; NUL 2&gt;&amp;1&quot;</span>, prioritynames[ level ] . w_name , name , syslogbuffer );
<a name="l00246"></a>00246                                                                 system( eventbuffer );
<a name="l00247"></a>00247 <span class="preprocessor">#endif</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span>                                                                FreeNoLog( syslogbuffer );
<a name="l00249"></a>00249                                                                 FreeNoLog( eventbuffer );
<a name="l00250"></a>00250                                                                 break ;
<a name="l00251"></a>00251                                                 <span class="keywordflow">default</span>:
<a name="l00252"></a>00252                                                                 fprintf( out , <span class="stringliteral">&quot;%s:%ld %s-&gt;%s:%d &quot;</span> , prioritynames[ level ] . c_name , time( NULL ) , file , func , line  ); 
<a name="l00253"></a>00253                                                                 va_start (args, format);
<a name="l00254"></a>00254                                                                 vfprintf( out, format , args ); 
<a name="l00255"></a>00255                                                                 va_end( args );
<a name="l00256"></a>00256                                                                 fprintf( out, <span class="stringliteral">&quot;\n&quot;</span> ); 
<a name="l00257"></a>00257                                                                 break ;
<a name="l00258"></a>00258                                 }
<a name="l00259"></a>00259                 }
<a name="l00260"></a>00260 }  <span class="comment">/* _n_log( ... ) */</span>
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="comment"></span>
<a name="l00264"></a>00264 <span class="comment">/*!\fn open_safe_logging( TS_LOG **log , char *pathname , char *opt )</span>
<a name="l00265"></a>00265 <span class="comment"> *\brief Open a thread-safe logging file</span>
<a name="l00266"></a>00266 <span class="comment"> *\param log A TS_LOG handler</span>
<a name="l00267"></a>00267 <span class="comment"> *\param pathname The file path (if any) and name</span>
<a name="l00268"></a>00268 <span class="comment"> *\param opt Options for opening (please never forget to use &quot;w&quot;)</span>
<a name="l00269"></a>00269 <span class="comment"> *\return TRUE on success , FALSE on error , -1000 if already open</span>
<a name="l00270"></a>00270 <span class="comment"> */</span>
<a name="l00271"></a><a class="code" href="n__log_8c.html#a6fe220b07534463abfdfc631df9ea37c">00271</a> <span class="keywordtype">int</span> <a class="code" href="n__log_8c.html#a6fe220b07534463abfdfc631df9ea37c" title="Open a thread-safe logging file.">open_safe_logging</a>( TS_LOG **log , <span class="keywordtype">char</span> *pathname , <span class="keywordtype">char</span> *opt ) 
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273 
<a name="l00274"></a>00274                 <span class="keywordflow">if</span>( (*log) ){
<a name="l00275"></a>00275 
<a name="l00276"></a>00276                                 <span class="keywordflow">if</span>( (*log) -&gt; file )
<a name="l00277"></a>00277                                                 <span class="keywordflow">return</span> -1000; <span class="comment">/* already open */</span>
<a name="l00278"></a>00278 
<a name="l00279"></a>00279                                 <span class="keywordflow">return</span> FALSE;
<a name="l00280"></a>00280                 }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282                 <span class="keywordflow">if</span>( !pathname ) <span class="keywordflow">return</span> FALSE; <span class="comment">/* no path/filename */</span>
<a name="l00283"></a>00283 
<a name="l00284"></a>00284                 Malloc( (*log) , TS_LOG , 1 );
<a name="l00285"></a>00285 
<a name="l00286"></a>00286                 <span class="keywordflow">if</span>( !(*log) )
<a name="l00287"></a>00287                                 <span class="keywordflow">return</span> FALSE;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289                 pthread_mutex_init( &amp;(*log) -&gt; LOG_MUTEX , NULL );
<a name="l00290"></a>00290 
<a name="l00291"></a>00291                 (*log) -&gt; file = fopen( pathname , opt );
<a name="l00292"></a>00292 
<a name="l00293"></a>00293                 <span class="keywordflow">if</span>( !(*log) -&gt; file )
<a name="l00294"></a>00294                                 <span class="keywordflow">return</span> FALSE;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296                 <span class="keywordflow">return</span> TRUE;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298 }<span class="comment">/* open_safe_logging(...) */</span>
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 
<a name="l00301"></a>00301 <span class="comment"></span>
<a name="l00302"></a>00302 <span class="comment">/*!\fn write_safe_log( TS_LOG *log , char *pat , ... )</span>
<a name="l00303"></a>00303 <span class="comment"> *\brief write to a thread-safe logging file</span>
<a name="l00304"></a>00304 <span class="comment"> *\param log A TS_LOG handler</span>
<a name="l00305"></a>00305 <span class="comment"> *\param pat Pattern for writting (i.e &quot;%d %d %s&quot;)</span>
<a name="l00306"></a>00306 <span class="comment"> *\return TRUE on success, FALSE on error</span>
<a name="l00307"></a>00307 <span class="comment"> */</span>
<a name="l00308"></a><a class="code" href="n__log_8c.html#ab4f3f3a8e1509e34a337489a1c01c3bc">00308</a> <span class="keywordtype">int</span> <a class="code" href="n__log_8c.html#ab4f3f3a8e1509e34a337489a1c01c3bc" title="write to a thread-safe logging file">write_safe_log</a>( TS_LOG *log , <span class="keywordtype">char</span> *pat , ... ) 
<a name="l00309"></a>00309 {
<a name="l00310"></a>00310                 <span class="comment">/* argument list */</span>
<a name="l00311"></a>00311                 va_list arg;
<a name="l00312"></a>00312                 <span class="keywordtype">char</span> str[2048] = <span class="stringliteral">&quot;&quot;</span> ;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314                 <span class="keywordflow">if</span>( !log )
<a name="l00315"></a>00315                                 <span class="keywordflow">return</span> FALSE;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317                 va_start( arg , pat );
<a name="l00318"></a>00318 
<a name="l00319"></a>00319                 vsnprintf( str , <span class="keyword">sizeof</span>(str), pat, arg );
<a name="l00320"></a>00320 
<a name="l00321"></a>00321                 va_end( arg );
<a name="l00322"></a>00322 
<a name="l00323"></a>00323                 pthread_mutex_lock( &amp;log -&gt; LOG_MUTEX );
<a name="l00324"></a>00324 
<a name="l00325"></a>00325                 fprintf( log -&gt; file , <span class="stringliteral">&quot;%s&quot;</span> , str );
<a name="l00326"></a>00326 
<a name="l00327"></a>00327                 pthread_mutex_unlock( &amp;log -&gt; LOG_MUTEX );
<a name="l00328"></a>00328 
<a name="l00329"></a>00329                 <span class="keywordflow">return</span> TRUE;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 } <span class="comment">/* write_safe_log( ... ) */</span>
<a name="l00332"></a>00332 
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="comment"></span>
<a name="l00335"></a>00335 <span class="comment">/*!\fn close_safe_logging( TS_LOG *log )</span>
<a name="l00336"></a>00336 <span class="comment"> *\brief close a thread-safe logging file</span>
<a name="l00337"></a>00337 <span class="comment"> *\param log A TS_LOG handler</span>
<a name="l00338"></a>00338 <span class="comment"> *\return TRUE on success, FALSE on error</span>
<a name="l00339"></a>00339 <span class="comment"> */</span>
<a name="l00340"></a><a class="code" href="n__log_8c.html#af0d5aacf8b212f23aa79563588e34869">00340</a> <span class="keywordtype">int</span> <a class="code" href="n__log_8c.html#af0d5aacf8b212f23aa79563588e34869" title="close a thread-safe logging file">close_safe_logging</a>( TS_LOG *log )
<a name="l00341"></a>00341 {
<a name="l00342"></a>00342                 <span class="keywordflow">if</span>( !log )
<a name="l00343"></a>00343                                 <span class="keywordflow">return</span> FALSE;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345                 pthread_mutex_destroy( &amp;log -&gt; LOG_MUTEX );
<a name="l00346"></a>00346 
<a name="l00347"></a>00347                 fclose( log -&gt; file );
<a name="l00348"></a>00348 
<a name="l00349"></a>00349                 <span class="keywordflow">return</span> TRUE;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351 }<span class="comment">/* close_safe_logging( ...) */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Oct 26 2018 12:00:39 for Nilorea Library by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
